<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { 
            margin: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; 
            height: 100vh; background: transparent; font-family: 'Segoe UI', sans-serif; color: white;
        }

        .top-row { display: flex; gap: 15px; margin-bottom: 20px; }
        
        .widget {
            display: flex; flex-direction: column; align-items: center;
            background: rgba(15, 15, 15, 0.95); border-radius: 20px; padding: 15px; width: 180px; text-align: center;
            transition: all 0.5s ease;
        }

        /* 2. MADDE: ALTIN PARLAMA ANƒ∞MASYONU */
        @keyframes gold-glow {
            0% { box-shadow: 0 0 15px #ffd700; border-color: #ffd700; }
            50% { box-shadow: 0 0 35px #ff8c00; border-color: #ff8c00; }
            100% { box-shadow: 0 0 15px #ffd700; border-color: #ffd700; }
        }

        .master-theme {
    width: 260px; 
    border: 5px solid #ffd700; 
    background: linear-gradient(180deg, #0f0f0f 0%, #3a2a00 100%);
    animation: gold-glow 2s infinite ease-in-out;
    position: relative; /* Canvas i√ßin gerekli */
    overflow: hidden;   /* Konfetiyi hapsetmek i√ßin */
    
    /* Merkeze hizalama komutlarƒ± */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

        .gift-theme { border: 4px solid #fe2c55; }
        .like-theme { border: 4px solid #00f2ea; }
        .chat-theme { border: 4px solid #2f9250; }

        .title { font-size: 11px; font-weight: 800; margin-bottom: 10px; text-transform: uppercase; }
        .gift-theme .title { color: #fe2c55; }
        .like-theme .title { color: #00f2ea; }
        .chat-theme .title { color: #2f9250; }
        .master-theme .title { color: #ffd700; font-size: 14px; letter-spacing: 2px; }

        .avatar { width: 100px; height: 100px; border-radius: 50%; border: 3px solid white; object-fit: cover; display: none; }
        .master-theme .avatar { width: 135px; height: 135px; border: 4px solid #ffd700; }
        
        .username { margin-top: 10px; font-weight: bold; font-size: 16px; width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .master-theme .username { font-size: 24px; color: #ffd700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        
        .stat-value { font-size: 13px; margin-top: 4px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="top-row">
        <div id="gift-widget" class="widget gift-theme">
            <div class="title">EN √áOK DESTEKLEYEN</div>
            <img id="gift-avatar" class="avatar">
            <div id="gift-name" class="username">Hen√ºz kimse yok...</div>
            <div id="gift-value" class="stat-value" style="color: #fe2c55;"></div>
        </div>
        <div id="like-widget" class="widget like-theme">
            <div class="title">EN √áOK BEƒûENEN</div>
            <img id="like-avatar" class="avatar">
            <div id="like-name" class="username">Hen√ºz kimse yok...</div>
            <div id="like-value" class="stat-value" style="color: #00f2ea;"></div>
        </div>
        <div id="chat-widget" class="widget chat-theme">
            <div class="title">EN √áOK YORUM ATAN</div>
            <img id="chat-avatar" class="avatar">
            <div id="chat-name" class="username">Hen√ºz kimse yok...</div>
            <div id="chat-value" class="stat-value" style="color: #2f9250;"></div>
        </div>
    </div>

  <div id="master-widget" class="widget master-theme">
    <canvas id="confetti-canvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;"></canvas>
    
    <div style="position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; width: 100%;">
        <div class="title">üèÜ ETKƒ∞LE≈ûƒ∞M KRALI üèÜ</div>
        <img id="master-avatar" class="avatar">
        <div id="master-name" class="username">Hen√ºz kimse yok.</div>
        <div id="master-value" class="stat-value" style="color: #ffd700;"></div>
    </div>
</div>
</div>

    <script>
        let stats = {}; 
        let leaders = { gift: {n: "", v: 0}, like: {n: "", v: 0}, chat: {n: "", v: 0}, master: {n: "", v: 0} };

        const socket = new WebSocket('ws://localhost:21213/');

        // 3. MADDE: SADECE KUTUCUK √úZERƒ∞NDE KONFETƒ∞ PATLATMA
// Konfeti nesnesini tuvale baƒüla (Global alanda bir kez tanƒ±mlƒ±yoruz)
let myConfetti;

function celebrate() {
    const canvas = document.getElementById('confetti-canvas');
    
    // Eƒüer daha √∂nce tanƒ±mlanmadƒ±ysa konfeti motorunu bu tuvale √∂zel ba≈ülat
    if (!myConfetti) {
        myConfetti = confetti.create(canvas, {
            resize: true,
            useWorker: true
        });
    }

    // Konfeti patlat (Kutunun merkezinden)
    myConfetti({
        particleCount: 40,
        spread: 50,
        origin: { y: 0.5, x: 0.5 }, // Tuvalin (kutunun) tam merkezi
        colors: ['#ffd700', '#ffffff', '#ff8c00'],
        gravity: 1.5,
        ticks: 150,
        scalar: 0.5 // Taneleri biraz k√º√ß√ºltt√ºk ki kutu i√ßine sƒ±ƒüsƒ±n
    });
}


        socket.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            const d = msg.data;
            if (!d || !d.uniqueId) return;

            const uid = d.uniqueId;
            if (!stats[uid]) stats[uid] = { g: 0, l: 0, c: 0, p: d.profilePictureUrl };

            if (msg.event === "gift") {
                const val = (d.diamondCount || 0) * (d.repeatCount || 1);
                stats[uid].g += val;
                if (stats[uid].g > leaders.gift.v) {
                    leaders.gift = {n: uid, v: stats[uid].g};
                    updateUI('gift', uid, stats[uid].g + " Elmas", d.profilePictureUrl);
                }
            }

            if (msg.event === "like") {
                const instantLikes = d.likeCount || 1;
                stats[uid].l += instantLikes;
                if (stats[uid].l > leaders.like.v) {
                    leaders.like = {n: uid, v: stats[uid].l};
                    updateUI('like', uid, stats[uid].l + " Beƒüeni", d.profilePictureUrl);
                }
            }

            if (msg.event === "chat") {
                stats[uid].c += 1;
                if (stats[uid].c > leaders.chat.v) {
                    leaders.chat = {n: uid, v: stats[uid].c};
                    updateUI('chat', uid, stats[uid].c + " Yorum", d.profilePictureUrl);
                }
            }

            // Master Skor Hesaplama
            const totalScore = (stats[uid].g * 50) + (stats[uid].c * 10) + stats[uid].l;
            
            // Eƒüer yeni birisi lider olursa konfeti patlat
            if (totalScore > leaders.master.v && uid !== leaders.master.n) {
                leaders.master = {n: uid, v: totalScore};
                updateUI('master', uid, "Skor: " + totalScore, d.profilePictureUrl);
                celebrate(); // KONFETƒ∞!
                console.log("Yeni Kral: " + uid);
            } else if (totalScore > leaders.master.v) {
                // Sadece skor g√ºncelleniyorsa konfeti patlatma, sadece sayƒ±yƒ± artƒ±r
                leaders.master.v = totalScore;
                document.getElementById('master-value').innerText = "Skor: " + totalScore;
            }
        };

        function updateUI(type, name, val, pic) {
            document.getElementById(type + '-name').innerText = name;
            document.getElementById(type + '-value').innerText = val;
            const img = document.getElementById(type + '-avatar');
            if (pic) { img.src = pic; img.style.display = 'block'; }
        }
    </script>
</body>
</html>